--Docker command
docker run --name betplaydb -e POSTGRES_PASSWORD=pass -d -p 5432:5432 -v C:\Users\LUIS\IdeaProjects\Betplay\db:/var/lib/postgresql/data  postgres -c log_statement=all
docker run --name betplaydb -e POSTGRES_PASSWORD=pass -d -p 5432:5432 -v ${PWD}/db:/var/lib/postgresql/data  postgres -c log_statement=all


-----------------------------------------------------------------------------------------------
-- Tables creation
-----------------------------------------------------------------------------------------------

CREATE TABLE nba_team (
    id INTEGER PRIMARY KEY,
    name TEXT,
    alias TEXT,
    short_name text,
    games_played NUMERIC,
    total_average NUMERIC,
    first_quarter_average NUMERIC,
    second_quarter_average NUMERIC,
    third_quarter_average NUMERIC,
    fourth_quarter_average numeric,
    wins_home INTEGER,
    losses_home INTEGER,
    wins_away INTEGER,
    losses_away INTEGER,
    conference text,
    standing_conference INTEGER,
    standing_overall INTEGER
);

CREATE TABLE bets (
    id SERIAL PRIMARY KEY,
    match_name TEXT,
    bet_name TEXT,
    game_date timestamp,
    team1_id integer REFERENCES nba_team,
    team2_id integer REFERENCES nba_team,
    bet_type TEXT,
    line NUMERIC,
    odd numeric,
    date timestamp,
    betplay_id text,
    deleted boolean default false
);


CREATE TABLE bet_change (
    id SERIAL PRIMARY KEY,
    bets_id integer REFERENCES bets,
    old_odd numeric,
    new_odd numeric,
    difference numeric,
    action text,
    date timestamp,
    message TEXT
);


CREATE TABLE nba_matches (
    id SERIAL PRIMARY KEY,
    team1_id integer REFERENCES nba_team,
    team1_quarter1_points numeric,
    team1_quarter2_points numeric,
    team1_quarter3_points numeric,
    team1_quarter4_points numeric,
    team1_total_points numeric,
    team2_id integer REFERENCES nba_team,
    team2_quarter1_points numeric,
    team2_quarter2_points numeric,
    team2_quarter3_points numeric,
    team2_quarter4_points numeric,
    team2_total_points numeric,
    game_date timestamp
);


CREATE TABLE ai_nba_response (
    id SERIAL PRIMARY KEY,
    match_name TEXT,
    question text,
    response TEXT,
    ai_provider text,
    ai_model TEXT,
    value text,
    response_date timestamp
);


CREATE TABLE nba_team_other_statistics (
    id SERIAL PRIMARY KEY,
    team_id integer REFERENCES nba_team,
    key TEXT,
    value text,
    updated_date timestamp
);


CREATE TABLE bet_placed (
    id SERIAL PRIMARY KEY,
    number_matches integer,
    total_odd numeric,
    amount_bet_pesos numeric,
    amount_earned numeric,
    status TEXT,
    date timestamp
);


CREATE TABLE bet_placed_matches (
    id SERIAL PRIMARY KEY,
    bet_placed_id integer REFERENCES bet_placed,
    match_name TEXT,
    match_date timestamp,
    type text,
    line numeric,
    odd numeric,
    ai_prediction numeric,
    outcome_id TEXT,
    status TEXT,
    real_points numeric,
    hash_identifier TEXT
);



-----------------------------------------------------------------------------------------------
-- useful queries
-----------------------------------------------------------------------------------------------
-- apuesta por encima de Solo registros activos
with minimo_partido
as (select min(line) line, match_name from BETS where deleted = false group by match_name)
select B.id, B.match_name , B.bet_name , B.game_date ,  nt1.alias, nt2.alias m, B.bet_type, B.line , B.odd, B."date", deleted
from BETS B, minimo_partido mp, nba_team nt1, nba_team nt2
where MP.match_name = b.match_name and MP.line = b.line and nt1.id = team1_id and nt2.id = team2_id
	and b.bet_type  = 'OT_OVER'
	and date(game_date) = date(NOW())
order by b.line

-- apuesta por debajo de Solo registros activos
with minimo_partido
as (select max(line) line, match_name from BETS where deleted = false  group by match_name)
select B.id, B.match_name , B.bet_name , B.game_date ,  nt1.alias, nt2.alias m, B.bet_type, B.line , B.odd, B."date"
from BETS B, minimo_partido mp, nba_team nt1, nba_team nt2
where MP.match_name = b.match_name and MP.line = b.line and nt1.id = team1_id and nt2.id = team2_id
	and b.bet_type  = 'OT_UNDER'
	and date(game_date) = date(NOW())
order by b.line desc




-- apuesta por encima historico
with minimo_partido
as (select min(line) line, match_name from BETS group by match_name)
select B.id, B.match_name , B.bet_name , B.game_date ,  nt1.alias, nt2.alias m, B.bet_type, B.line , B.odd, B."date", deleted
from BETS B, minimo_partido mp, nba_team nt1, nba_team nt2
where MP.match_name = b.match_name and MP.line = b.line and nt1.id = team1_id and nt2.id = team2_id
	and b.bet_type  = 'OT_OVER'
	and date(game_date) = date(NOW())
order by b.line

-- apuesta por debajo  historico
with minimo_partido
as (select max(line) line, match_name from BETS group by match_name)
select B.id, B.match_name , B.bet_name , B.game_date ,  nt1.alias, nt2.alias m, B.bet_type, B.line , B.odd, B."date", deleted
from BETS B, minimo_partido mp, nba_team nt1, nba_team nt2
where MP.match_name = b.match_name and MP.line = b.line and nt1.id = team1_id and nt2.id = team2_id
	and b.bet_type  = 'OT_UNDER'
	and date(game_date) = date(NOW())
order by b.line desc



-- Cuanto ha cambiado la cuota de cierto partido y line
select b.match_name , b.bet_name, b.bet_type, b.line, bc.old_odd , bc.new_odd , bc."action" , bc."date" , bc.message
from bet_change bc, bets b
where bc.bets_id = b.id
	and line = 191.500000 and b.bet_type = 'OT_OVER' and b.match_name = 'Cleveland Cavaliers - Charlotte Hornets'
order by bc."date";


-- Promedio de todos los equipos
select sum(first_quarter_average) / count(*) primer,
	   sum(second_quarter_average) / count(*) segundo,
	   sum(third_quarter_average) / count(*) tercer,
	   sum(fourth_quarter_average) / count(*) cuarto,
	   sum(fourth_quarter_average + third_quarter_average + second_quarter_average + first_quarter_average) / count(*) total
from nba_team nt

-- Promedio de ciertos equipos
select sum(first_quarter_average) / count(*) primer,
	   sum(second_quarter_average) / count(*) segundo,
	   sum(third_quarter_average) / count(*) tercer,
	   sum(fourth_quarter_average) / count(*) cuarto,
	   sum(fourth_quarter_average + third_quarter_average + second_quarter_average + first_quarter_average) / count(*) total
from nba_team nt
where alias in ('Cavaliers', 'Hornets')

-- Apuestas con nombre de cada equipo y sus promedios (Puntos Debajo de)
select match_name, nt1.alias, nt1.total_average, nt2.alias, nt2.total_average, b.bet_type , b.line , b.odd
from bets b, nba_team nt1, nba_team nt2
where b.team1 like '%' || nt1.alias || '%' and
	b.team2 like '%' || nt2.alias || '%' and
	b.bet_type  = 'OT_OVER'
order by b.line

-- Apuestas con nombre de cada equipo y sus promedios (Puntos encima de)
select match_name, nt1.alias, nt1.total_average, nt2.alias, nt2.total_average, b.bet_type , b.line , b.odd
from bets b, nba_team nt1, nba_team nt2
where b.team1 like '%' || nt1.alias || '%' and
	b.team2 like '%' || nt2.alias || '%' and
	b.bet_type  = 'OT_UNDER'
order by b.line desc


-- Partidos de un equipos de local y de visitiante
select nt1.alias, 'Local', nmm.team1_quarter1_points , nmm.team1_quarter2_points , nmm.team1_quarter3_points , nmm.team1_quarter4_points , nmm.team1_total_points ,
	   nmm.game_date
from nba_matches nmm, nba_team nt1
where nmm.team1_id = nt1.id
	and (nt1.alias = 'Hornets')
union all
select nt1.alias, 'Visitante', nmm.team1_quarter1_points , nmm.team1_quarter2_points , nmm.team1_quarter3_points , nmm.team1_quarter4_points , nmm.team1_total_points ,
	   nmm.game_date
from nba_matches nmm, nba_team nt1
where nmm.team2_id = nt1.id
	and (nt1.alias = 'Hornets')
order by team1_total_points


-- Enferntamientos previos entre dos equipos
select nt1.alias, nmm.team1_quarter1_points , nmm.team1_quarter2_points , nmm.team1_quarter3_points , nmm.team1_quarter4_points , nmm.team1_total_points ,
	   nt2.alias, nmm.team2_quarter1_points , nmm.team2_quarter2_points , nmm.team2_quarter3_points, nmm.team2_quarter4_points , nmm.team2_total_points ,
	   nmm.game_date
from nba_matches nmm, nba_team nt1, nba_team nt2
where nmm.team1_id = nt1.id and nmm.team2_id = nt2.id
	and ((nt1.alias = 'Hornets' and nt2.alias = 'Cavaliers') or (nt1.alias = 'Cavaliers' and nt2.alias = 'Hornets'))


-- Partidos por debajo de cierto puntaje
select (team1_total_points + team2_total_points) total_puntos,
	   nt1.alias, nmm.team1_quarter1_points , nmm.team1_quarter2_points , nmm.team1_quarter3_points , nmm.team1_quarter4_points , nmm.team1_total_points ,
	   nt2.alias, nmm.team2_quarter1_points , nmm.team2_quarter2_points , nmm.team2_quarter3_points, nmm.team2_quarter4_points , nmm.team2_total_points ,
	   nmm.game_date
from nba_matches nmm, nba_team nt1, nba_team nt2
where nmm.team1_id = nt1.id and nmm.team2_id = nt2.id
	and (team1_total_points + team2_total_points) < 196


-- AI by date
select *
from ai_nba_response
where match_name like '%2024-04-02%'
order by match_name desc, response_date


-- AI vs actual match
select nt1.alias, nmm.team1_total_points ,
	   nt2.alias, nmm.team2_total_points ,
	   nmm.game_date,
	   (nmm.team1_total_points + nmm.team2_total_points) real_value,
	   ai.value ai_value,
	   ((nmm.team1_total_points + nmm.team2_total_points) - ai.value::INTEGER) difference,
	   ai.match_name , ai.question , ai.response, ai.ai_model
from nba_matches nmm, nba_team nt1, nba_team nt2, ai_nba_response ai
where nmm.team1_id = nt1.id and nmm.team2_id = nt2.id
	and ai.match_name like '%' || nt1.alias || '%' and ai.match_name like '%' || nt2.alias || '%' and ai.match_name like '%' || date(nmm.game_date) || '%'


-- AI average vs actual match
with ai_average_matches
as (
select match_name, avg(value::INTEGER) average_points
from ai_nba_response ai
group by match_name
)
select nt1.alias, nmm.team1_total_points ,
	   nt2.alias, nmm.team2_total_points ,
	   nmm.game_date,
	   (nmm.team1_total_points + nmm.team2_total_points) real_value,
	   ai.average_points ai_value,
	   ((nmm.team1_total_points + nmm.team2_total_points) - ai.average_points::INTEGER) difference,
	   ai.match_name
from nba_matches nmm, nba_team nt1, nba_team nt2, ai_average_matches ai
where nmm.team1_id = nt1.id and nmm.team2_id = nt2.id
	and ai.match_name like '%' || nt1.alias || '%' and ai.match_name like '%' || nt2.alias || '%' and ai.match_name like '%' || date(nmm.game_date) || '%'
	--and ai.match_name like '%2024-11-15%'
order by difference